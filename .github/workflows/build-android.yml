---
# yamllint disable rule:line-length
name: Android Build & Publish

'on':
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      skip_aab:
        description: Skip building the Android AAB (debug)
        type: boolean
        default: false
      enable_ai_notes:
        description: Use GitHub Models to summarize Play notes
        type: boolean
        default: true

permissions:
  contents: read
  actions: write
  models: read

jobs:
  build-android-internal:
    name: Build & publish internal AAB
    runs-on: ubuntu-latest
    env:
      ANDROID_NDK_VERSION: 26.1.10909125
      SKIP_AAB: ${{ (github.event_name == 'workflow_dispatch' && inputs.skip_aab) && 'true' || 'false' }}
      ENABLE_AI_NOTES: ${{ (github.event_name != 'workflow_dispatch' || inputs.enable_ai_notes) && 'true' || 'false' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Derive version and changelog
        run: |
          VERSION=$(jq -r .version package.json)
          # versionCode formula: (major * 1000000 + minor * 1000 + patch) * 1000 + run_suffix
          # Example: 1.41.4 run 5 â†’ (1*1000000 + 41*1000 + 4) * 1000 + 5 = 1041004005
          # This allows 1000 builds per version while maintaining monotonic ordering
          BASE_CODE=$(echo "$VERSION" | awk -F. '{print ($1 * 1000000) + ($2 * 1000) + $3}')
          RUN_SUFFIX=$(( ${{ github.run_number }} % 1000 ))
          VERSION_CODE=$(( BASE_CODE * 1000 + RUN_SUFFIX ))
          echo "APP_VERSION=$VERSION" >> $GITHUB_ENV
          echo "APP_VERSION_CODE=$VERSION_CODE" >> $GITHUB_ENV
          echo "Using versionCode: $VERSION_CODE (base: $BASE_CODE, run: $RUN_SUFFIX)"
          mkdir -p whatsnew
          python3 scripts/extract-changelog.py "$VERSION" > whatsnew/en-US.long.txt
          if [ ! -s whatsnew/en-US.long.txt ]; then echo "Internal build $VERSION" > whatsnew/en-US.long.txt; fi

      - name: Set up Node.js
        if: env.SKIP_AAB != 'true'
        uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'
          cache: 'yarn'

      - name: Set up Java 17
        if: env.SKIP_AAB != 'true'
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: '17'
          cache: gradle

      - name: Set up Gradle cache
        if: env.SKIP_AAB != 'true'
        uses: gradle/actions/setup-gradle@v5

      - name: Set up Android SDK
        if: env.SKIP_AAB != 'true'
        uses: android-actions/setup-android@v3

      - name: Install Android components
        if: env.SKIP_AAB != 'true'
        run: |
          sdk_root="${ANDROID_SDK_ROOT:-$ANDROID_HOME}"
          sdkmanager_bin="$sdk_root/cmdline-tools/latest/bin/sdkmanager"
          yes | "$sdkmanager_bin" --licenses >/dev/null
          yes | "$sdkmanager_bin" --install \
            "build-tools;36.0.0" \
            "platform-tools" \
            "platforms;android-36" \
            "ndk;${ANDROID_NDK_VERSION}"

      - name: Configure NDK paths
        if: env.SKIP_AAB != 'true'
        run: |
          echo "NDK_HOME=$ANDROID_SDK_ROOT/ndk/${ANDROID_NDK_VERSION}" >> $GITHUB_ENV
          echo "ANDROID_NDK_HOME=$ANDROID_SDK_ROOT/ndk/${ANDROID_NDK_VERSION}" >> $GITHUB_ENV

      - name: Set up Rust toolchain
        if: env.SKIP_AAB != 'true'
        uses: dtolnay/rust-toolchain@stable

      - name: Add Android Rust targets
        if: env.SKIP_AAB != 'true'
        run: rustup target add aarch64-linux-android

      - name: Install sccache
        if: env.SKIP_AAB != 'true'
        uses: mozilla-actions/sccache-action@v0.0.9

      - name: Configure sccache for Rust
        if: env.SKIP_AAB != 'true'
        run: |
          echo "SCCACHE_GHA_ENABLED=true" >> $GITHUB_ENV
          echo "RUSTC_WRAPPER=sccache" >> $GITHUB_ENV

      - name: Cache cargo
        if: env.SKIP_AAB != 'true'
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: true
          workspaces: |
            src-tauri -> target

      - name: Install HID build dependencies
        if: env.SKIP_AAB != 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y libudev-dev libusb-1.0-0-dev

      - name: Install dependencies
        if: env.SKIP_AAB != 'true'
        run: yarn install --immutable

      - name: Sync Tauri version from package.json
        if: env.SKIP_AAB != 'true'
        run: node scripts/sync-tauri-version.mjs

      - name: Prepare signing keystore
        if: env.SKIP_AAB != 'true'
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_ALIAS_PASSWORD: ${{ secrets.ANDROID_KEY_ALIAS_PASSWORD }}
        run: |
          echo "$ANDROID_KEYSTORE_BASE64" | base64 -d > "$RUNNER_TEMP/upload.keystore"
          echo "ANDROID_UPLOAD_KEYSTORE=$RUNNER_TEMP/upload.keystore" >> $GITHUB_ENV
          echo "ANDROID_UPLOAD_KEYSTORE_PASSWORD=$ANDROID_KEYSTORE_PASSWORD" >> $GITHUB_ENV
          echo "ANDROID_UPLOAD_KEY_ALIAS=$ANDROID_KEY_ALIAS" >> $GITHUB_ENV
          echo "ANDROID_UPLOAD_KEY_PASSWORD=$ANDROID_KEY_ALIAS_PASSWORD" >> $GITHUB_ENV

      - name: Build Android AAB
        if: env.SKIP_AAB != 'true'
        env:
          ANDROID_UPLOAD_KEYSTORE: ${{ env.ANDROID_UPLOAD_KEYSTORE }}
          ANDROID_UPLOAD_KEYSTORE_PASSWORD: ${{ env.ANDROID_UPLOAD_KEYSTORE_PASSWORD }}
          ANDROID_UPLOAD_KEY_ALIAS: ${{ env.ANDROID_UPLOAD_KEY_ALIAS }}
          ANDROID_UPLOAD_KEY_PASSWORD: ${{ env.ANDROID_UPLOAD_KEY_PASSWORD }}
          TAURI_ANDROID_VERSION_CODE: ${{ env.APP_VERSION_CODE }}
          VITE_NOWNODES_API_KEY: ${{ secrets.VITE_NOWNODES_API_KEY }}
          VITE_ADA_API_KEY: ${{ secrets.VITE_ADA_API_KEY }}
          VITE_SOL_API_KEY: ${{ secrets.VITE_SOL_API_KEY }}
        run: |
          echo "Building with versionCode: $TAURI_ANDROID_VERSION_CODE"
          # Build only aarch64 (ARM64) - covers 99%+ of modern Android devices
          # For full multi-arch release, add: armv7, i686, x86_64
          yarn tauri android build --target aarch64 --aab true --ci

      - name: Upload AAB artifact
        if: env.SKIP_AAB != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: android-universal-aab
          path: |
            src-tauri/gen/android/app/build/outputs/bundle/universalRelease/app-universal-release.aab
            src-tauri/gen/android/app/build/outputs/mapping/universalRelease/mapping.txt
          if-no-files-found: error

      - name: Restore cached Play release notes summary
        id: cache_notes
        uses: actions/cache@v4
        with:
          path: whatsnew/en-US.txt
          key: play-whatsnew-en-US-${{ env.APP_VERSION }}-${{ hashFiles('whatsnew/en-US.long.txt') }}

      - name: Prepare AI prompt for Play release notes
        if: steps.cache_notes.outputs.cache-hit != 'true'
        run: |
          mkdir -p .tmp
          PROMPT_FILE=".tmp/play-summarize-prompt.txt"
          cat > "$PROMPT_FILE" << 'PROMPT_END'
          Rewrite the following Google Play "What's new" notes to 500 characters or less.
          Plain text only.
          Keep the most important user-facing changes.
          Sound slightly exciting and playful with a few emojis where it makes sense.
          ---
          PROMPT_END
          cat whatsnew/en-US.long.txt >> "$PROMPT_FILE"

      - name: Generate Play release notes summary with LLM
        id: ai_notes
        if: steps.cache_notes.outputs.cache-hit != 'true'
        continue-on-error: true
        uses: actions/ai-inference@v2
        with:
          model: openai/gpt-4o-mini
          prompt-file: .tmp/play-summarize-prompt.txt

      - name: Write and validate Play release notes (cache miss)
        if: steps.cache_notes.outputs.cache-hit != 'true'
        env:
          SUMMARY: ${{ steps.ai_notes.outputs.response }}
        run: |
          python3 - <<'PY'
          from __future__ import annotations

          import os
          import re

          long_path = 'whatsnew/en-US.long.txt'
          out_path = 'whatsnew/en-US.txt'

          with open(long_path, 'r', encoding='utf-8') as f:
            original = f.read().strip()

          summary = (os.environ.get('SUMMARY') or '').strip()
          text = summary if summary else original

          text = text.replace('\r\n', '\n').replace('\r', '\n')
          text = re.sub(r'\s+', ' ', text).strip()

          if len(text) > 500:
            text = text[:500].rstrip()

          with open(out_path, 'w', encoding='utf-8') as f:
            f.write(text)
            f.write('\n')

          print(f"Release notes length: {len(text)} characters")
          assert len(text) <= 500, f"Too long: {len(text)}"
          PY

      - name: Validate cached Play release notes (cache hit)
        if: steps.cache_notes.outputs.cache-hit == 'true'
        run: |
          python3 - <<'PY'
          from __future__ import annotations

          out_path = 'whatsnew/en-US.txt'

          with open(out_path, 'r', encoding='utf-8') as f:
            text = f.read().strip()

          print(f"Release notes length: {len(text)} characters")
          assert len(text) <= 500, f"Too long: {len(text)}"
          PY

      - name: Prepare Play whatsnew directory
        run: |
          mkdir -p whatsnew/publish
          cp whatsnew/en-US.txt whatsnew/publish/en-US.txt

      - name: Publish to Play internal track
        if: env.SKIP_AAB != 'true'
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.PLAY_SERVICE_ACCOUNT_JSON }}
          packageName: org.thorchain.asgardex
          releaseFiles: src-tauri/gen/android/app/build/outputs/bundle/universalRelease/app-universal-release.aab
          track: internal
          status: draft
          releaseName: v${{ env.APP_VERSION }}
          whatsNewDirectory: whatsnew/publish
