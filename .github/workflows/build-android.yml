---
# yamllint disable rule:line-length
name: Android Build & Publish

'on':
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      skip_aab:
        description: Skip building the Android AAB (debug)
        type: boolean
        default: false

permissions:
  contents: read
  actions: write

jobs:
  build-android-internal:
    name: Build & publish internal AAB
    runs-on: ubuntu-latest
    env:
      ANDROID_NDK_VERSION: 26.1.10909125
      SKIP_AAB: ${{ (github.event_name == 'workflow_dispatch' && inputs.skip_aab) && 'true' || 'false' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Derive version and changelog
        run: |
          VERSION=$(jq -r .version package.json)
          # versionCode formula: (major * 1000000 + minor * 1000 + patch) * 1000 + run_suffix
          # Example: 1.41.4 run 5 → (1*1000000 + 41*1000 + 4) * 1000 + 5 = 1041004005
          # This allows 1000 builds per version while maintaining monotonic ordering
          BASE_CODE=$(echo "$VERSION" | awk -F. '{print ($1 * 1000000) + ($2 * 1000) + $3}')
          RUN_SUFFIX=$(( ${{ github.run_number }} % 1000 ))
          VERSION_CODE=$(( BASE_CODE * 1000 + RUN_SUFFIX ))
          echo "APP_VERSION=$VERSION" >> $GITHUB_ENV
          echo "APP_VERSION_CODE=$VERSION_CODE" >> $GITHUB_ENV
          echo "Using versionCode: $VERSION_CODE (base: $BASE_CODE, run: $RUN_SUFFIX)"
          mkdir -p whatsnew
          python3 scripts/extract-changelog.py "$VERSION" > whatsnew/en-US.long.txt
          if [ ! -s whatsnew/en-US.long.txt ]; then echo "Internal build $VERSION" > whatsnew/en-US.long.txt; fi

      - name: Set up Node.js
        if: env.SKIP_AAB != 'true'
        uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'
          cache: 'yarn'

      - name: Set up Java 17
        if: env.SKIP_AAB != 'true'
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: '17'
          cache: gradle

      - name: Set up Gradle cache
        if: env.SKIP_AAB != 'true'
        uses: gradle/actions/setup-gradle@v5

      - name: Set up Android SDK
        if: env.SKIP_AAB != 'true'
        uses: android-actions/setup-android@v3

      - name: Install Android components
        if: env.SKIP_AAB != 'true'
        run: |
          sdk_root="${ANDROID_SDK_ROOT:-$ANDROID_HOME}"
          sdkmanager_bin="$sdk_root/cmdline-tools/latest/bin/sdkmanager"
          yes | "$sdkmanager_bin" --licenses >/dev/null
          yes | "$sdkmanager_bin" --install \
            "build-tools;36.0.0" \
            "platform-tools" \
            "platforms;android-36" \
            "ndk;${ANDROID_NDK_VERSION}"

      - name: Configure NDK paths
        if: env.SKIP_AAB != 'true'
        run: |
          echo "NDK_HOME=$ANDROID_SDK_ROOT/ndk/${ANDROID_NDK_VERSION}" >> $GITHUB_ENV
          echo "ANDROID_NDK_HOME=$ANDROID_SDK_ROOT/ndk/${ANDROID_NDK_VERSION}" >> $GITHUB_ENV

      - name: Set up Rust toolchain
        if: env.SKIP_AAB != 'true'
        uses: dtolnay/rust-toolchain@stable

      - name: Add Android Rust targets
        if: env.SKIP_AAB != 'true'
        run: rustup target add aarch64-linux-android

      - name: Install sccache
        if: env.SKIP_AAB != 'true'
        uses: mozilla-actions/sccache-action@v0.0.9

      - name: Configure sccache for Rust
        if: env.SKIP_AAB != 'true'
        run: |
          echo "SCCACHE_GHA_ENABLED=true" >> $GITHUB_ENV
          echo "RUSTC_WRAPPER=sccache" >> $GITHUB_ENV

      - name: Cache cargo
        if: env.SKIP_AAB != 'true'
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: true
          workspaces: |
            src-tauri -> target

      - name: Install HID build dependencies
        if: env.SKIP_AAB != 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y libudev-dev libusb-1.0-0-dev

      - name: Install dependencies
        if: env.SKIP_AAB != 'true'
        run: yarn install --immutable

      - name: Sync Tauri version from package.json
        if: env.SKIP_AAB != 'true'
        run: node scripts/sync-tauri-version.mjs

      - name: Prepare signing keystore
        if: env.SKIP_AAB != 'true'
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_ALIAS_PASSWORD: ${{ secrets.ANDROID_KEY_ALIAS_PASSWORD }}
        run: |
          echo "$ANDROID_KEYSTORE_BASE64" | base64 -d > "$RUNNER_TEMP/upload.keystore"
          echo "ANDROID_UPLOAD_KEYSTORE=$RUNNER_TEMP/upload.keystore" >> $GITHUB_ENV
          echo "ANDROID_UPLOAD_KEYSTORE_PASSWORD=$ANDROID_KEYSTORE_PASSWORD" >> $GITHUB_ENV
          echo "ANDROID_UPLOAD_KEY_ALIAS=$ANDROID_KEY_ALIAS" >> $GITHUB_ENV
          echo "ANDROID_UPLOAD_KEY_PASSWORD=$ANDROID_KEY_ALIAS_PASSWORD" >> $GITHUB_ENV

      - name: Build Android AAB
        if: env.SKIP_AAB != 'true'
        env:
          ANDROID_UPLOAD_KEYSTORE: ${{ env.ANDROID_UPLOAD_KEYSTORE }}
          ANDROID_UPLOAD_KEYSTORE_PASSWORD: ${{ env.ANDROID_UPLOAD_KEYSTORE_PASSWORD }}
          ANDROID_UPLOAD_KEY_ALIAS: ${{ env.ANDROID_UPLOAD_KEY_ALIAS }}
          ANDROID_UPLOAD_KEY_PASSWORD: ${{ env.ANDROID_UPLOAD_KEY_PASSWORD }}
          TAURI_ANDROID_VERSION_CODE: ${{ env.APP_VERSION_CODE }}
          VITE_NOWNODES_API_KEY: ${{ secrets.VITE_NOWNODES_API_KEY }}
          VITE_ADA_API_KEY: ${{ secrets.VITE_ADA_API_KEY }}
          VITE_SOL_API_KEY: ${{ secrets.VITE_SOL_API_KEY }}
        run: |
          echo "Building with versionCode: $TAURI_ANDROID_VERSION_CODE"
          # Build only aarch64 (ARM64) - covers 99%+ of modern Android devices
          # For full multi-arch release, add: armv7, i686, x86_64
          yarn tauri android build --target aarch64 --aab true --ci

      - name: Upload AAB artifact
        if: env.SKIP_AAB != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: android-universal-aab
          path: |
            src-tauri/gen/android/app/build/outputs/bundle/universalRelease/app-universal-release.aab
            src-tauri/gen/android/app/build/outputs/mapping/universalRelease/mapping.txt
          if-no-files-found: error

      - name: Summarize Play release notes
        run: |
          python3 - <<'PY'
          """Summarize changelog to ≤500 chars by adding lines until limit reached."""
          import re

          long_path = 'whatsnew/en-US.long.txt'
          out_path = 'whatsnew/en-US.txt'
          max_len = 500
          suffix = '...and more!'

          with open(long_path, 'r', encoding='utf-8') as f:
              raw_lines = f.readlines()

          # Filter and clean lines
          lines: list[str] = []
          for ln in raw_lines:
              ln = ln.rstrip()
              if not ln.strip():
                  continue
              # Skip markdown headers (lines starting with optional whitespace + #)
              if re.match(r'^\s*#+', ln):
                  continue
              # Strip markdown links: [text](url) -> text
              ln = re.sub(r'\[([^\]]+)\]\([^)]+\)', r'\1', ln)
              lines.append(ln)

          result_lines: list[str] = []
          current_len = 0

          for line in lines:
              # Calculate length if we add this line (with newline separator)
              sep_len = 1 if result_lines else 0
              new_len = current_len + sep_len + len(line)

              if new_len <= max_len:
                  result_lines.append(line)
                  current_len = new_len
              else:
                  # Would exceed limit - add suffix instead and stop
                  sep_len = 1 if result_lines else 0
                  if current_len + sep_len + len(suffix) <= max_len:
                      result_lines.append(suffix)
                  break

          text = '\n'.join(result_lines)

          with open(out_path, 'w', encoding='utf-8') as f:
              f.write(text)
              f.write('\n')

          print(f"Release notes: {len(text)} chars, {len(result_lines)} lines")
          assert len(text) <= max_len, f"Too long: {len(text)}"
          PY

      - name: Prepare Play whatsnew directory
        run: |
          mkdir -p whatsnew/publish
          cp whatsnew/en-US.txt whatsnew/publish/en-US.txt

      - name: Publish to Play internal track
        if: env.SKIP_AAB != 'true'
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.PLAY_SERVICE_ACCOUNT_JSON }}
          packageName: org.thorchain.asgardex
          releaseFiles: src-tauri/gen/android/app/build/outputs/bundle/universalRelease/app-universal-release.aab
          track: internal
          status: draft
          releaseName: v${{ env.APP_VERSION }}
          whatsNewDirectory: whatsnew/publish
